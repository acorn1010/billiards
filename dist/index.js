"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[826],{"./src/events/aimevent.ts":(e,t,n)=>{n.d(t,{f:()=>d});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.module.js");function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function h(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?a(e):t;var n}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(h,e);var t,n,r,u=p(h);function h(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),l(a(e=u.call(this)),"verticalOffset",0),l(a(e),"sideOffset",0),l(a(e),"angle",0),l(a(e),"power",0),l(a(e),"pos",new s.Pa4(0,0,0)),e.type=i.t.AIM,e}return t=h,r=[{key:"fromJson",value:function(e){var t=new h;return t.pos=(0,o.Bh)(e.pos),t.angle=e.angle,t.verticalOffset=e.verticalOffset,t.sideOffset=e.sideOffset,t.power=e.power,t}}],(n=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return h.fromJson(this)}},{key:"round",value:function(){this.angle=(0,o.NM)(this.angle),this.power=(0,o.NM)(this.power),this.verticalOffset=(0,o.NM)(this.verticalOffset),this.sideOffset=(0,o.NM)(this.sideOffset)}}])&&c(t.prototype,n),r&&c(t,r),h}(r.Z)},"./src/events/eventtype.ts":(e,t,n)=>{var r;n.d(t,{t:()=>r}),function(e){e.BEGIN="BEGIN",e.BREAK="BREAK",e.WATCHAIM="WATCHAIM",e.AIM="AIM",e.HIT="HIT",e.STATIONARY="STATIONARY",e.CHAT="CHAT",e.ABORT="ABORT",e.PLACEBALL="PLACEBALL"}(r||(r={}))},"./src/events/gameevent.ts":(e,t,n)=>{n.d(t,{Z:()=>r});var r=function e(){var t,n,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r=void 0,(n="type")in(t=this)?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r}},"./src/index.ts":(e,t,n)=>{var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=s(e);if(t){var i=s(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return a(this,n)}}var u=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(a,e);var t,n,r,s=l(a);function a(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(e=s.call(this)).type=i.t.STATIONARY,e}return t=a,(n=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}])&&o(t.prototype,n),r&&o(t,r),a}(r.Z),h=n("./src/model/table.ts"),f=n("./node_modules/three/build/three.module.js"),p=n("./src/utils/utils.ts"),d=n("./src/view/tablegeometry.ts");function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"viewPoint",value:function(t,n){var r=1/(2*Math.tan(n*Math.PI/360));if(t>this.portrait){var i=t>e.aspectLimit?2.75*d.H.tableY:2.4*d.H.tableX/t;return new f.Pa4(0,-.1,r*i)}var o=t>1/e.aspectLimit?4.9*d.H.tableY:1.35*d.H.tableX/t;return new f.Pa4(-.1,0,r*o)}}],(n=null)&&m(t.prototype,n),r&&m(t,r),e}();function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}y(v,"aspectLimit",1.78),y(v,"portrait",.95);var w=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),g(this,"camera",void 0),g(this,"mode",this.topView),g(this,"mainMode",this.aimView),g(this,"height",4),g(this,"elapsed",void 0),this.camera=new f.cPb(45,t,.1,1e3)}var t,n,r;return t=e,n=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.position.lerp(v.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=p.up,this.camera.lookAt(p.bM)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08;this.camera.fov=this.camera.aspect<.8?65:45,this.camera.position.lerp(e.pos.clone().addScaledVector((0,p.AA)(e.angle),-9),t),this.camera.position.z=this.height,this.camera.up=p.up,this.camera.lookAt(e.pos.clone().addScaledVector(p.up,1))}},{key:"adjustHeight",value:function(e){this.height=f.M8C.clamp(this.height+e,1,6)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],n&&b(t.prototype,n),r&&b(t,r),e}();let T,x,k,A;function R(e,t=1/0,n=null){x||(x=new f._12(2,2,1,1)),k||(k=new f.jyz({uniforms:{blitTexture:new f.xWb(e)},vertexShader:"\n            varying vec2 vUv;\n            void main(){\n                vUv = uv;\n                gl_Position = vec4(position.xy * 1.0,0.,.999999);\n            }",fragmentShader:"\n            uniform sampler2D blitTexture; \n            varying vec2 vUv;\n\n            void main(){ \n                gl_FragColor = vec4(vUv.xy, 0, 1);\n                \n                #ifdef IS_SRGB\n                gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );\n                #else\n                gl_FragColor = texture2D( blitTexture, vUv);\n                #endif\n            }"})),k.uniforms.blitTexture.value=e,k.defines.IS_SRGB=e.colorSpace==f.KI_,k.needsUpdate=!0,A||(A=new f.Kj0(x,k),A.frustrumCulled=!1);const r=new f.cPb,i=new f.xsS;i.add(A),n||(n=T=new f.CP7({antialias:!1})),n.setSize(Math.min(e.image.width,t),Math.min(e.image.height,t)),n.clear(),n.render(i,r);const o=new f.xEZ(n.domElement);return o.minFilter=e.minFilter,o.magFilter=e.magFilter,o.wrapS=e.wrapS,o.wrapT=e.wrapT,o.name=e.name,T&&(T.dispose(),T=null),o}const E={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class S{constructor(){this.pluginCallbacks=[],this.register((function(e){return new ae(e)})),this.register((function(e){return new ce(e)})),this.register((function(e){return new he(e)})),this.register((function(e){return new fe(e)})),this.register((function(e){return new pe(e)})),this.register((function(e){return new de(e)})),this.register((function(e){return new le(e)})),this.register((function(e){return new ue(e)})),this.register((function(e){return new me(e)})),this.register((function(e){return new ye(e)})),this.register((function(e){return new ve(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){const i=new se,o=[];for(let s=0,a=this.pluginCallbacks.length;s<a;s++)o.push(this.pluginCallbacks[s](i));i.setPlugins(o),i.write(e,t,r).catch(n)}parseAsync(e,t){const n=this;return new Promise((function(r,i){n.parse(e,r,i,t)}))}}const M=0,O=1,P=2,_=3,I=4,C=5120,j=5121,L=5122,N=5123,H=5124,B=5125,F=5126,U=34962,D=34963,G=9728,z=9729,K=9984,V=9985,W=9986,X=9987,Y=33071,Z=33648,J=10497,q="KHR_mesh_quantization",Q={};Q[f.TyD]=G,Q[f.YLQ]=K,Q[f.aH4]=W,Q[f.wem]=z,Q[f.qyh]=V,Q[f.D1R]=X,Q[f.uWy]=Y,Q[f.rpg]=J,Q[f.OoA]=Z;const $={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},ee=new f.Ilk;function te(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}function ne(e){return 4*Math.ceil(e/4)}function re(e,t=0){const n=ne(e.byteLength);if(n!==e.byteLength){const r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function ie(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function oe(e,t){if(void 0!==e.toBlob)return new Promise((n=>e.toBlob(n,t)));let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}class se{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const r=this,i=r.buffers,o=r.json;n=r.options;const s=r.extensionsUsed,a=r.extensionsRequired,c=new Blob(i,{type:"application/octet-stream"}),l=Object.keys(s),u=Object.keys(a);if(l.length>0&&(o.extensionsUsed=l),u.length>0&&(o.extensionsRequired=u),o.buffers&&o.buffers.length>0&&(o.buffers[0].byteLength=c.size),!0===n.binary){const e=new FileReader;e.readAsArrayBuffer(c),e.onloadend=function(){const n=re(e.result),r=new DataView(new ArrayBuffer(8));r.setUint32(0,n.byteLength,!0),r.setUint32(4,5130562,!0);const i=re((s=JSON.stringify(o),(new TextEncoder).encode(s).buffer),32);var s;const a=new DataView(new ArrayBuffer(8));a.setUint32(0,i.byteLength,!0),a.setUint32(4,1313821514,!0);const c=new ArrayBuffer(12),l=new DataView(c);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);const u=12+a.byteLength+i.byteLength+r.byteLength+n.byteLength;l.setUint32(8,u,!0);const h=new Blob([c,a,i,r,n],{type:"application/octet-stream"}),f=new FileReader;f.readAsArrayBuffer(h),f.onloadend=function(){t(f.result)}}}else if(o.buffers&&o.buffers.length>0){const e=new FileReader;e.readAsDataURL(c),e.onloadend=function(){const n=e.result;o.buffers[0].uri=n,t(o)}}else t(o)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const n=this.options,r=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+i.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new f.Pa4;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),r=new f.Pa4;for(let i=0,o=n.count;i<o;i++)r.fromBufferAttribute(n,i),0===r.x&&0===r.y&&0===r.z?r.setX(1):r.normalize(),n.setXYZ(i,r.x,r.y,r.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const r={};0===t.offset.x&&0===t.offset.y||(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),1===t.repeat.x&&1===t.repeat.y||(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function n(e){return e.colorSpace===f.KI_?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof f.EB7&&(e=R(e)),t instanceof f.EB7&&(t=R(t));const r=e?e.image:null,i=t?t.image:null,o=Math.max(r?r.width:0,i?i.width:0),s=Math.max(r?r.height:0,i?i.height:0),a=ie();a.width=o,a.height=s;const c=a.getContext("2d");c.fillStyle="#00ffff",c.fillRect(0,0,o,s);const l=c.getImageData(0,0,o,s);if(r){c.drawImage(r,0,0,o,s);const t=n(e),i=c.getImageData(0,0,o,s).data;for(let e=2;e<i.length;e+=4)l.data[e]=256*t(i[e]/256)}if(i){c.drawImage(i,0,0,o,s);const e=n(t),r=c.getImageData(0,0,o,s).data;for(let t=1;t<r.length;t+=4)l.data[t]=256*e(r[t]/256)}c.putImageData(l,0,0);const u=(e||t).clone();return u.source=new f.Hw6(a),u.colorSpace=f.aCh,u.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),u}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,r,i){const o=this.json;let s;switch(o.bufferViews||(o.bufferViews=[]),t){case C:case j:s=1;break;case L:case N:s=2;break;default:s=4}const a=ne(r*e.itemSize*s),c=new DataView(new ArrayBuffer(a));let l=0;for(let h=n;h<n+r;h++)for(let n=0;n<e.itemSize;n++){let r;e.itemSize>4?r=e.array[h*e.itemSize+n]:(0===n?r=e.getX(h):1===n?r=e.getY(h):2===n?r=e.getZ(h):3===n&&(r=e.getW(h)),!0===e.normalized&&(r=f.M8C.normalize(r,e.array))),t===F?c.setFloat32(l,r,!0):t===H?c.setInt32(l,r,!0):t===B?c.setUint32(l,r,!0):t===L?c.setInt16(l,r,!0):t===N?c.setUint16(l,r,!0):t===C?c.setInt8(l,r):t===j&&c.setUint8(l,r),l+=s}const u={buffer:this.processBuffer(c.buffer),byteOffset:this.byteOffset,byteLength:a};void 0!==i&&(u.target=i),i===U&&(u.byteStride=e.itemSize*s),this.byteOffset+=a,o.bufferViews.push(u);return{id:o.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise((function(r){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const e=re(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}}))}processAccessor(e,t,n,r){const i=this.json;let o;if(e.array.constructor===Float32Array)o=F;else if(e.array.constructor===Int32Array)o=H;else if(e.array.constructor===Uint32Array)o=B;else if(e.array.constructor===Int16Array)o=L;else if(e.array.constructor===Uint16Array)o=N;else if(e.array.constructor===Int8Array)o=C;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);o=j}if(void 0===n&&(n=0),void 0===r&&(r=e.count),0===r)return null;const s=function(e,t,n){const r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+n;i++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[i*e.itemSize+t]:(0===t?n=e.getX(i):1===t?n=e.getY(i):2===t?n=e.getZ(i):3===t&&(n=e.getW(i)),!0===e.normalized&&(n=f.M8C.normalize(n,e.array))),r.min[t]=Math.min(r.min[t],n),r.max[t]=Math.max(r.max[t],n)}return r}(e,n,r);let a;void 0!==t&&(a=e===t.index?D:U);const c=this.processBufferView(e,o,n,r,a),l={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:r,max:s.max,min:s.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(l.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(l)-1}processImage(e,t,n,r="image/png"){if(null!==e){const i=this,o=i.cache,s=i.json,a=i.options,c=i.pending;o.images.has(e)||o.images.set(e,{});const l=o.images.get(e),u=r+":flipY/"+n.toString();if(void 0!==l[u])return l[u];s.images||(s.images=[]);const h={mimeType:r},p=ie();p.width=Math.min(e.width,a.maxTextureSize),p.height=Math.min(e.height,a.maxTextureSize);const d=p.getContext("2d");if(!0===n&&(d.translate(0,p.height),d.scale(1,-1)),void 0!==e.data){t!==f.wk1&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>a.maxTextureSize||e.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];d.putImageData(new ImageData(n,e.width,e.height),0,0)}else d.drawImage(e,0,0,p.width,p.height);!0===a.binary?c.push(oe(p,r).then((e=>i.processBufferViewImage(e))).then((e=>{h.bufferView=e}))):void 0!==p.toDataURL?h.uri=p.toDataURL(r):c.push(oe(p,r).then((e=>(new FileReader).readAsDataURL(e))).then((e=>{h.uri=e})));const m=s.images.push(h)-1;return l[u]=m,m}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:Q[e.magFilter],minFilter:Q[e.minFilter],wrapS:Q[e.wrapS],wrapT:Q[e.wrapT]};return t.samplers.push(n)-1}processTexture(e){const t=this.options,n=this.cache,r=this.json;if(n.textures.has(e))return n.textures.get(e);r.textures||(r.textures=[]),e instanceof f.EB7&&(e=R(e,t.maxTextureSize));let i=e.userData.mimeType;"image/webp"===i&&(i="image/png");const o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,i)};e.name&&(o.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,o)}));const s=r.textures.push(o)-1;return n.textures.set(e,s),s}processMaterial(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const r={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=e.color.toArray().concat([e.opacity]);if(te(i,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),n={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(n,t),r.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){const t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),r.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),r.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),r.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),r.occlusionTexture=t}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===f.ehD&&(r.doubleSided=!0),""!==e.name&&(r.name=e.name),this.serializeUserData(e,r),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,r)}));const o=n.materials.push(r)-1;return t.materials.set(e,o),o}processMesh(e){const t=this.cache,n=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let f=0,g=e.material.length;f<g;f++)r.push(e.material[f].uuid);else r.push(e.material.uuid);const i=r.join(":");if(t.meshes.has(i))return t.meshes.get(i);const o=e.geometry;let s;s=e.isLineSegments?O:e.isLineLoop?P:e.isLine?_:e.isPoints?M:e.material.wireframe?O:I;const a={},c={},l=[],u=[],h={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},p=o.getAttribute("normal");void 0===p||this.isNormalizedNormalAttribute(p)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),o.setAttribute("normal",this.createNormalizedNormalAttribute(p)));let d=null;for(let g in o.attributes){if("morph"===g.slice(0,5))continue;const e=o.attributes[g];g=h[g]||g.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(g)||(g="_"+g),t.attributes.has(this.getUID(e))){c[g]=t.attributes.get(this.getUID(e));continue}d=null;const n=e.array;"JOINTS_0"!==g||n instanceof Uint16Array||n instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),d=new f.TlE(new Uint16Array(n),e.itemSize,e.normalized));const r=this.processAccessor(d||e,o);null!==r&&(g.startsWith("_")||this.detectMeshQuantization(g,e),c[g]=r,t.attributes.set(this.getUID(e),r))}if(void 0!==p&&o.setAttribute("normal",p),0===Object.keys(c).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const n=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let s=0;s<e.morphTargetInfluences.length;++s){const a={};let c=!1;for(const e in o.morphAttributes){if("position"!==e&&"normal"!==e){c||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),c=!0);continue}const n=o.morphAttributes[e][s],r=e.toUpperCase(),i=o.attributes[e];if(t.attributes.has(this.getUID(n,!0))){a[r]=t.attributes.get(this.getUID(n,!0));continue}const l=n.clone();if(!o.morphTargetsRelative)for(let e=0,t=n.count;e<t;e++)for(let r=0;r<n.itemSize;r++)0===r&&l.setX(e,n.getX(e)-i.getX(e)),1===r&&l.setY(e,n.getY(e)-i.getY(e)),2===r&&l.setZ(e,n.getZ(e)-i.getZ(e)),3===r&&l.setW(e,n.getW(e)-i.getW(e));a[r]=this.processAccessor(l,o),t.attributes.set(this.getUID(i,!0),a[r])}u.push(a),n.push(e.morphTargetInfluences[s]),void 0!==e.morphTargetDictionary&&r.push(i[s])}a.weights=n,r.length>0&&(a.extras={},a.extras.targetNames=r)}const m=Array.isArray(e.material);if(m&&0===o.groups.length)return null;const y=m?e.material:[e.material],v=m?o.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let f=0,g=v.length;f<g;f++){const e={mode:s,attributes:c};if(this.serializeUserData(o,e),u.length>0&&(e.targets=u),null!==o.index){let n=this.getUID(o.index);void 0===v[f].start&&void 0===v[f].count||(n+=":"+v[f].start+":"+v[f].count),t.attributes.has(n)?e.indices=t.attributes.get(n):(e.indices=this.processAccessor(o.index,o,v[f].start,v[f].count),t.attributes.set(n,e.indices)),null===e.indices&&delete e.indices}const n=this.processMaterial(y[v[f].materialIndex]);null!==n&&(e.material=n),l.push(e)}a.primitives=l,n.meshes||(n.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,a)}));const b=n.meshes.push(a)-1;return t.meshes.set(i,b),b}detectMeshQuantization(e,t){if(this.extensionsUsed[q])return;let n;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");const r=e.split("_",1)[0];E[r]&&E[r].includes(n)&&(this.extensionsUsed[q]=!0,this.extensionsRequired[q]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,r={type:n?"orthographic":"perspective"};return n?r.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:f.M8C.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){const n=this.json,r=this.nodeMap;n.animations||(n.animations=[]);const i=(e=S.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,o=[],s=[];for(let a=0;a<i.length;++a){const e=i[a],n=f.iUV.parseTrackName(e.name);let c=f.iUV.findNode(t,n.nodeName);const l=$[n.propertyName];if("bones"===n.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(n.objectIndex):void 0),!c||!l)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',e.name),null;const u=1;let h,p=e.values.length/e.times.length;l===$.morphTargetInfluences&&(p/=c.morphTargetInfluences.length),!0===e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(h="CUBICSPLINE",p/=3):h=e.getInterpolation()===f.Syv?"STEP":"LINEAR",s.push({input:this.processAccessor(new f.TlE(e.times,u)),output:this.processAccessor(new f.TlE(e.values,p)),interpolation:h}),o.push({sampler:s.length-1,target:{node:r.get(c),path:l}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:s,channels:o}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,r=t.nodes[n.get(e)],i=e.skeleton;if(void 0===i)return null;const o=e.skeleton.bones[0];if(void 0===o)return null;const s=[],a=new Float32Array(16*i.bones.length),c=new f.yGw;for(let l=0;l<i.bones.length;++l)s.push(n.get(i.bones[l])),c.copy(i.boneInverses[l]),c.multiply(e.bindMatrix).toArray(a,16*l);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new f.TlE(a,16)),joints:s,skeleton:n.get(o)});return r.skin=t.skins.length-1}processNode(e){const t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(n.trs){const t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();te(t,[0,0,0,1])||(i.rotation=t),te(n,[0,0,0])||(i.translation=n),te(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===te(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let r=0,i=e.children.length;r<i;r++){const i=e.children[r];if(i.visible||!1===n.onlyVisible){const e=this.processNode(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));const o=t.nodes.push(i)-1;return r.set(e,o),o}processScene(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);const i=[];for(let o=0,s=e.children.length;o<s;o++){const t=e.children[o];if(t.visible||!1===n.onlyVisible){const e=this.processNode(t);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}processObjects(e){const t=new f.xsS;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const n=[];for(let r=0;r<e.length;r++)e[r]instanceof f.xsS?this.processScene(e[r]):n.push(e[r]);n.length>0&&this.processObjects(n);for(let r=0;r<this.skins.length;++r)this.processSkin(this.skins[r]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,n=this.plugins.length;t<n;t++)e(this.plugins[t])}}class ae{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);const s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class ce{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class le{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:n.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:n.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:n.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class ue{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:n.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:n.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class he{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const t={index:n.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class fe{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const t={index:n.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class pe{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class de{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(ee)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){const t={index:n.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){const t={index:n.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class me{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){const t={index:n.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:n.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class ye{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){const t={index:n.processTexture(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class ve{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}function be(e,t){if(t===f.WwZ)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===f.z$h||t===f.UlW){let n=e.getIndex();if(null===n){const t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,i=[];if(t===f.z$h)for(let e=1;e<=r;e++)i.push(n.getX(0)),i.push(n.getX(e)),i.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(i.push(n.getX(e)),i.push(n.getX(e+1)),i.push(n.getX(e+2))):(i.push(n.getX(e+2)),i.push(n.getX(e+1)),i.push(n.getX(e)));i.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(i),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}S.Utils={insertKeyframe:function(e,t){const n=.001,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));let a;if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;a=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<n)return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),a=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<n)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),a=i.length-1}else for(let c=0;c<e.times.length;c++){if(Math.abs(e.times[c]-t)<n)return c;if(e.times[c]<t&&e.times[c+1]>t){i.set(e.times.slice(0,c+1),0),i[c+1]=t,i.set(e.times.slice(c+1),c+2),o.set(e.values.slice(0,(c+1)*r),0),o.set(s.evaluate(t),(c+1)*r),o.set(e.values.slice((c+1)*r),(c+2)*r),a=c+1;break}}return e.times=i,e.values=o,a},mergeMorphTargetTracks:function(e,t){const n=[],r={},i=e.tracks;for(let o=0;o<i.length;++o){let e=i[o];const s=f.iUV.parseTrackName(e.name),a=f.iUV.findNode(t,s.nodeName);if("morphTargetInfluences"!==s.propertyName||void 0===s.propertyIndex){n.push(e);continue}if(e.createInterpolant!==e.InterpolantFactoryMethodDiscrete&&e.createInterpolant!==e.InterpolantFactoryMethodLinear){if(e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),e=e.clone(),e.setInterpolation(f.NMF)}const c=a.morphTargetInfluences.length,l=a.morphTargetDictionary[s.propertyIndex];if(void 0===l)throw new Error("THREE.GLTFExporter: Morph target name not found: "+s.propertyIndex);let u;if(void 0===r[a.uuid]){u=e.clone();const t=new u.ValueBufferType(c*u.times.length);for(let e=0;e<u.times.length;e++)t[e*c+l]=u.values[e];u.name=(s.nodeName||"")+".morphTargetInfluences",u.values=t,r[a.uuid]=u,n.push(u);continue}const h=e.createInterpolant(new e.ValueBufferType(1));u=r[a.uuid];for(let t=0;t<u.times.length;t++)u.values[t*c+l]=h.evaluate(u.times[t]);for(let t=0;t<e.times.length;t++){const n=this.insertKeyframe(u,e.times[t]);u.values[n*c+l]=e.values[t]}}return e.tracks=n,e}};class ge extends f.aNw{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Re(e)})),this.register((function(e){return new Ce(e)})),this.register((function(e){return new je(e)})),this.register((function(e){return new Le(e)})),this.register((function(e){return new Se(e)})),this.register((function(e){return new Me(e)})),this.register((function(e){return new Oe(e)})),this.register((function(e){return new Pe(e)})),this.register((function(e){return new Ae(e)})),this.register((function(e){return new _e(e)})),this.register((function(e){return new Ee(e)})),this.register((function(e){return new Ie(e)})),this.register((function(e){return new xe(e)})),this.register((function(e){return new Ne(e)})),this.register((function(e){return new He(e)}))}load(e,t,n,r){const i=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:f.Zp0.extractUrlBase(e),this.manager.itemStart(e);const s=function(t){r?r(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},a=new f.hH6(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(n){try{i.parse(n,o,(function(n){t(n),i.manager.itemEnd(e)}),s)}catch(r){s(r)}}),n,s)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i;const o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Be){try{o[Te.KHR_BINARY_GLTF]=new De(e)}catch(l){return void(r&&r(l))}i=JSON.parse(o[Te.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new ft(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const e=this.pluginCallbacks[u](c);s[e.name]=e,o[e.name]=!0}if(i.extensionsUsed)for(let u=0;u<i.extensionsUsed.length;++u){const e=i.extensionsUsed[u],t=i.extensionsRequired||[];switch(e){case Te.KHR_MATERIALS_UNLIT:o[e]=new ke;break;case Te.KHR_DRACO_MESH_COMPRESSION:o[e]=new Ge(i,this.dracoLoader);break;case Te.KHR_TEXTURE_TRANSFORM:o[e]=new ze;break;case Te.KHR_MESH_QUANTIZATION:o[e]=new Ke;break;default:t.indexOf(e)>=0&&void 0===s[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}c.setExtensions(o),c.setPlugins(s),c.parse(n,r)}parseAsync(e,t){const n=this;return new Promise((function(r,i){n.parse(e,t,r,i)}))}}function we(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Te={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class xe{constructor(e){this.parser=e,this.name=Te.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let r=t.cache.get(n);if(r)return r;const i=t.json,o=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let s;const a=new f.Ilk(16777215);void 0!==o.color&&a.setRGB(...o.color,f.GUF);const c=void 0!==o.range?o.range:0;switch(o.type){case"directional":s=new f.Ox3(a),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new f.cek(a),s.distance=c;break;case"spot":s=new f.PMe(a),s.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,s.angle=o.spot.outerConeAngle,s.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return s.position.set(0,0,0),s.decay=2,st(s,o),void 0!==o.intensity&&(s.intensity=o.intensity),s.name=t.createUniqueName(o.name||"light_"+e),r=Promise.resolve(s),t.cache.add(n,r),r}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return n._getNodeRef(t.cache,i,e)}))}}class ke{constructor(){this.name=Te.KHR_MATERIALS_UNLIT}getMaterialType(){return f.vBJ}extendParams(e,t,n){const r=[];e.color=new f.Ilk(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(...t,f.GUF),e.opacity=t[3]}void 0!==i.baseColorTexture&&r.push(n.assignTexture(e,"map",i.baseColorTexture,f.KI_))}return Promise.all(r)}}class Ae{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class Re{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&i.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&i.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(i.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new f.FM8(e,e)}return Promise.all(i)}}class Ee{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class Se{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new f.Ilk(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=r.extensions[this.name];return void 0!==o.sheenColorFactor&&t.sheenColor.setRGB(...o.sheenColorFactor,f.GUF),void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&i.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,f.KI_)),void 0!==o.sheenRoughnessTexture&&i.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class Me{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class Oe{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&i.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const s=o.attenuationColor||[1,1,1];return t.attenuationColor=(new f.Ilk).setRGB(...s,f.GUF),Promise.all(i)}}class Pe{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class _e{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&i.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const s=o.specularColorFactor||[1,1,1];return t.specularColor=(new f.Ilk).setRGB(...s,f.GUF),void 0!==o.specularColorTexture&&i.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,f.KI_)),Promise.all(i)}}class Ie{constructor(e){this.parser=e,this.name=Te.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f.EJi:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Ce{constructor(e){this.parser=e,this.name=Te.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;const i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,o)}}class je{constructor(e){this.parser=e,this.name=Te.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],s=r.images[o.source];let a=n.textureLoader;if(s.uri){const e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,o.source,a);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Le{constructor(e){this.parser=e,this.name=Te.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],s=r.images[o.source];let a=n.textureLoader;if(s.uri){const e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,o.source,a);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Ne{constructor(e){this.name=Te.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then((function(t){const n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then((function(e){return e.buffer})):i.ready.then((function(){const t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t}))}))}return null}}class He{constructor(e){this.name=Te.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=t.meshes[n.mesh];for(const a of r.primitives)if(a.mode!==Ye.TRIANGLES&&a.mode!==Ye.TRIANGLE_STRIP&&a.mode!==Ye.TRIANGLE_FAN&&void 0!==a.mode)return null;const i=n.extensions[this.name].attributes,o=[],s={};for(const a in i)o.push(this.parser.getDependency("accessor",i[a]).then((e=>(s[a]=e,s[a]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],r=e[0].count,i=[];for(const o of n){const e=new f.yGw,t=new f.Pa4,n=new f._fP,a=new f.Pa4(1,1,1),c=new f.SPe(o.geometry,o.material,r);for(let i=0;i<r;i++)s.TRANSLATION&&t.fromBufferAttribute(s.TRANSLATION,i),s.ROTATION&&n.fromBufferAttribute(s.ROTATION,i),s.SCALE&&a.fromBufferAttribute(s.SCALE,i),c.setMatrixAt(i,e.compose(t,n,a));for(const r in s)"TRANSLATION"!==r&&"ROTATION"!==r&&"SCALE"!==r&&o.geometry.setAttribute(r,s[r]);f.Tme.prototype.copy.call(c,o),this.parser.assignFinalMaterial(c),i.push(c)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]})))}}const Be="glTF",Fe=1313821514,Ue=5130562;class De{constructor(e){this.name=Te.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Be)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,r===Fe){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(r===Ue){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ge{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Te.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,s={},a={},c={};for(const l in o){const e=$e[l]||l.toLowerCase();s[e]=o[l]}for(const l in e.attributes){const t=$e[l]||l.toLowerCase();if(void 0!==o[l]){const r=n.accessors[e.attributes[l]],i=Ze[r.componentType];c[t]=i.name,a[t]=!0===r.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],r=a[t];void 0!==r&&(n.normalized=r)}t(e)}),s,c)}))}))}}class ze{constructor(){this.name=Te.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Ke{constructor(){this.name=Te.KHR_MESH_QUANTIZATION}}class Ve extends f._C8{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let o=0;o!==r;o++)t[o]=n[i+o];return t}interpolate_(e,t,n,r){const i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,c=3*s,l=r-t,u=(n-t)/l,h=u*u,f=h*u,p=e*c,d=p-c,m=-2*f+3*h,y=f-h,v=1-m,b=y-h+u;for(let g=0;g!==s;g++){const e=o[d+g+s],t=o[d+g+a]*l,n=o[p+g+s],r=o[p+g]*l;i[g]=v*e+b*t+m*n+y*r}return i}}const We=new f._fP;class Xe extends Ve{interpolate_(e,t,n,r){const i=super.interpolate_(e,t,n,r);return We.fromArray(i).normalize().toArray(i),i}}const Ye={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Ze={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Je={9728:f.TyD,9729:f.wem,9984:f.YLQ,9985:f.qyh,9986:f.aH4,9987:f.D1R},qe={33071:f.uWy,33648:f.OoA,10497:f.rpg},Qe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$e={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},et={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},tt={CUBICSPLINE:void 0,LINEAR:f.NMF,STEP:f.Syv},nt="OPAQUE",rt="MASK",it="BLEND";function ot(e,t,n){for(const r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function st(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function at(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ct(e){let t;const n=e.extensions&&e.extensions[Te.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+lt(n.attributes):e.indices+":"+lt(e.attributes)+":"+e.mode,void 0!==e.targets)for(let r=0,i=e.targets.length;r<i;r++)t+=":"+lt(e.targets[r]);return t}function lt(e){let t="";const n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ut(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ht=new f.yGw;class ft{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new we,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,r=!1,i=-1;"undefined"!=typeof navigator&&(n=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=navigator.userAgent.indexOf("Firefox")>-1,i=r?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||n||r&&i<98?this.textureLoader=new f.dpR(this.options.manager):this.textureLoader=new f.QRU(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new f.hH6(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};ot(i,o,r),st(o,r),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let r=0,i=t.length;r<i;r++){const n=t[r].joints;for(let t=0,r=n.length;t<r;t++)e[n[t]].isBone=!0}for(let r=0,i=e.length;r<i;r++){const t=e[r];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(n[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const r=n.clone(),i=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[r,o]of e.children.entries())i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const r=e(t[n]);if(r)return r}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let r=0;r<t.length;r++){const i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":r=this.loadCamera(t);break;default:if(r=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!r)throw new Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return n.getDependency(e,r)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Te.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(e,i){n.load(f.Zp0.resolveURL(t.uri,r.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)}))}loadAccessor(e){const t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse){const e=Qe[r.type],t=Ze[r.componentType],n=!0===r.normalized,i=new t(r.count*e);return Promise.resolve(new f.TlE(i,e,n))}const i=[];return void 0!==r.bufferView?i.push(this.getDependency("bufferView",r.bufferView)):i.push(null),void 0!==r.sparse&&(i.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(i).then((function(e){const i=e[0],o=Qe[r.type],s=Ze[r.componentType],a=s.BYTES_PER_ELEMENT,c=a*o,l=r.byteOffset||0,u=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,h=!0===r.normalized;let p,d;if(u&&u!==c){const e=Math.floor(l/u),n="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+e+":"+r.count;let c=t.cache.get(n);c||(p=new s(i,e*u,r.count*u/a),c=new f.vpT(p,u/a),t.cache.add(n,c)),d=new f.kB5(c,o,l%u/a,h)}else p=null===i?new s(r.count*o):new s(i,l,r.count*o),d=new f.TlE(p,o,h);if(void 0!==r.sparse){const t=Qe.SCALAR,n=Ze[r.sparse.indices.componentType],a=r.sparse.indices.byteOffset||0,c=r.sparse.values.byteOffset||0,l=new n(e[1],a,r.sparse.count*t),u=new s(e[2],c,r.sparse.count*o);null!==i&&(d=new f.TlE(d.array.slice(),d.itemSize,d.normalized));for(let e=0,r=l.length;e<r;e++){const t=l[e];if(d.setX(t,u[e*o]),o>=2&&d.setY(t,u[e*o+1]),o>=3&&d.setZ(t,u[e*o+2]),o>=4&&d.setW(t,u[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return d}))}loadTexture(e){const t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r];let o=this.textureLoader;if(i.uri){const e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){const r=this,i=this.json,o=i.textures[e],s=i.images[t],a=(s.uri||s.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=o.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);const n=(i.samplers||{})[o.sampler]||{};return t.magFilter=Je[n.magFilter]||f.wem,t.minFilter=Je[n.minFilter]||f.D1R,t.wrapS=qe[n.wrapS]||f.rpg,t.wrapT=qe[n.wrapT]||f.rpg,r.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=c,c}loadImageSource(e,t){const n=this,r=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=r.images[e],s=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(void 0!==o.bufferView)a=n.getDependency("bufferView",o.bufferView).then((function(e){c=!0;const t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then((function(e){return new Promise((function(n,r){let o=n;!0===t.isImageBitmapLoader&&(o=function(e){const t=new f.xEZ(e);t.needsUpdate=!0,n(t)}),t.load(f.Zp0.resolveURL(e,i.path),o,void 0,r)}))})).then((function(e){var t;return!0===c&&s.revokeObjectURL(a),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=l,l}assignTexture(e,t,n,r){const i=this;return this.getDependency("texture",n.index).then((function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[Te.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[Te.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(o);o=i.extensions[Te.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const r=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new f.UY4,f.F5T.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new f.nls,f.F5T.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(r||i||o){let e="ClonedMaterial:"+n.uuid+":";r&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),i&&(t.vertexColors=!0),o&&(t.flatShading=!0),r&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return f.Wid}loadMaterial(e){const t=this,n=this.json,r=this.extensions,i=n.materials[e];let o;const s={},a=[];if((i.extensions||{})[Te.KHR_MATERIALS_UNLIT]){const e=r[Te.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),a.push(e.extendParams(s,i,t))}else{const n=i.pbrMetallicRoughness||{};if(s.color=new f.Ilk(1,1,1),s.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;s.color.setRGB(e[0],e[1],e[2],f.GUF),s.opacity=e[3]}void 0!==n.baseColorTexture&&a.push(t.assignTexture(s,"map",n.baseColorTexture,f.KI_)),s.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,s.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(a.push(t.assignTexture(s,"metalnessMap",n.metallicRoughnessTexture)),a.push(t.assignTexture(s,"roughnessMap",n.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),a.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)}))))}!0===i.doubleSided&&(s.side=f.ehD);const c=i.alphaMode||nt;if(c===it?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,c===rt&&(s.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&o!==f.vBJ&&(a.push(t.assignTexture(s,"normalMap",i.normalTexture)),s.normalScale=new f.FM8(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;s.normalScale.set(e,e)}return void 0!==i.occlusionTexture&&o!==f.vBJ&&(a.push(t.assignTexture(s,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(s.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&o!==f.vBJ&&(s.emissive=(new f.Ilk).setRGB(...i.emissiveFactor,f.GUF)),void 0!==i.emissiveTexture&&o!==f.vBJ&&a.push(t.assignTexture(s,"emissiveMap",i.emissiveTexture,f.KI_)),Promise.all(a).then((function(){const n=new o(s);return i.name&&(n.name=i.name),st(n,i),t.associations.set(n,{materials:e}),i.extensions&&ot(r,n,i),n}))}createUniqueName(e){const t=f.iUV.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,r=this.primitiveCache;function i(e){return n[Te.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return pt(n,e,t)}))}const o=[];for(let s=0,a=e.length;s<a;s++){const n=e[s],a=ct(n),c=r[a];if(c)o.push(c.promise);else{let e;e=n.extensions&&n.extensions[Te.KHR_DRACO_MESH_COMPRESSION]?i(n):pt(new f.u9r,n,t),r[a]={primitive:n,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,r=this.extensions,i=n.meshes[e],o=i.primitives,s=[];for(let c=0,l=o.length;c<l;c++){const e=void 0===o[c].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new f.Wid({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:f.Wl3})),a.DefaultMaterial):this.getDependency("material",o[c].material);s.push(e)}var a;return s.push(t.loadGeometries(o)),Promise.all(s).then((function(n){const s=n.slice(0,n.length-1),a=n[n.length-1],c=[];for(let u=0,h=a.length;u<h;u++){const n=a[u],l=o[u];let h;const p=s[u];if(l.mode===Ye.TRIANGLES||l.mode===Ye.TRIANGLE_STRIP||l.mode===Ye.TRIANGLE_FAN||void 0===l.mode)h=!0===i.isSkinnedMesh?new f.TUv(n,p):new f.Kj0(n,p),!0===h.isSkinnedMesh&&h.normalizeSkinWeights(),l.mode===Ye.TRIANGLE_STRIP?h.geometry=be(h.geometry,f.UlW):l.mode===Ye.TRIANGLE_FAN&&(h.geometry=be(h.geometry,f.z$h));else if(l.mode===Ye.LINES)h=new f.ejS(n,p);else if(l.mode===Ye.LINE_STRIP)h=new f.x12(n,p);else if(l.mode===Ye.LINE_LOOP)h=new f.blk(n,p);else{if(l.mode!==Ye.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);h=new f.woe(n,p)}Object.keys(h.geometry.morphAttributes).length>0&&at(h,i),h.name=t.createUniqueName(i.name||"mesh_"+e),st(h,i),l.extensions&&ot(r,h,l),t.assignFinalMaterial(h),c.push(h)}for(let r=0,i=c.length;r<i;r++)t.associations.set(c[r],{meshes:e,primitives:r});if(1===c.length)return i.extensions&&ot(r,c[0],i),c[0];const l=new f.ZAu;i.extensions&&ot(r,l,i),t.associations.set(l,{meshes:e});for(let e=0,t=c.length;e<t;e++)l.add(c[e]);return l}))}loadCamera(e){let t;const n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new f.cPb(f.M8C.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new f.iKG(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),st(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let r=0,i=t.joints.length;r<i;r++)n.push(this._loadNodeShallow(t.joints[r]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),r=e,i=[],o=[];for(let s=0,a=r.length;s<a;s++){const e=r[s];if(e){i.push(e);const t=new f.yGw;null!==n&&t.fromArray(n.array,16*s),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new f.OdW(i,o)}))}loadAnimation(e){const t=this.json,n=this,r=t.animations[e],i=r.name?r.name:"animation_"+e,o=[],s=[],a=[],c=[],l=[];for(let u=0,h=r.channels.length;u<h;u++){const e=r.channels[u],t=r.samplers[e.sampler],n=e.target,i=n.node,h=void 0!==r.parameters?r.parameters[t.input]:t.input,f=void 0!==r.parameters?r.parameters[t.output]:t.output;void 0!==n.node&&(o.push(this.getDependency("node",i)),s.push(this.getDependency("accessor",h)),a.push(this.getDependency("accessor",f)),c.push(t),l.push(n))}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(a),Promise.all(c),Promise.all(l)]).then((function(e){const t=e[0],r=e[1],o=e[2],s=e[3],a=e[4],c=[];for(let i=0,l=t.length;i<l;i++){const e=t[i],l=r[i],u=o[i],h=s[i],f=a[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const p=n._createAnimationTracks(e,l,u,h,f);if(p)for(let t=0;t<p.length;t++)c.push(p[t])}return new f.m7l(i,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],r=t._loadNodeShallow(e),i=[],o=n.children||[];for(let a=0,c=o.length;a<c;a++)i.push(t.getDependency("node",o[a]));const s=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),s]).then((function(e){const t=e[0],n=e[1],r=e[2];null!==r&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(r,ht)}));for(let i=0,o=n.length;i<o;i++)t.add(n[i]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],o=i.name?r.createUniqueName(i.name):"",s=[],a=r._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return a&&s.push(a),void 0!==i.camera&&s.push(r.getDependency("camera",i.camera).then((function(e){return r._getNodeRef(r.cameraCache,i.camera,e)}))),r._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){s.push(e)})),this.nodeCache[e]=Promise.all(s).then((function(t){let s;if(s=!0===i.isBone?new f.N$j:t.length>1?new f.ZAu:1===t.length?t[0]:new f.Tme,s!==t[0])for(let e=0,n=t.length;e<n;e++)s.add(t[e]);if(i.name&&(s.userData.name=i.name,s.name=o),st(s,i),i.extensions&&ot(n,s,i),void 0!==i.matrix){const e=new f.yGw;e.fromArray(i.matrix),s.applyMatrix4(e)}else void 0!==i.translation&&s.position.fromArray(i.translation),void 0!==i.rotation&&s.quaternion.fromArray(i.rotation),void 0!==i.scale&&s.scale.fromArray(i.scale);return r.associations.has(s)||r.associations.set(s,{}),r.associations.get(s).nodes=e,s})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],r=this,i=new f.ZAu;n.name&&(i.name=r.createUniqueName(n.name)),st(i,n),n.extensions&&ot(t,i,n);const o=n.nodes||[],s=[];for(let a=0,c=o.length;a<c;a++)s.push(r.getDependency("node",o[a]));return Promise.all(s).then((function(e){for(let t=0,n=e.length;t<n;t++)i.add(e[t]);return r.associations=(e=>{const t=new Map;for(const[n,i]of r.associations)(n instanceof f.F5T||n instanceof f.xEZ)&&t.set(n,i);return e.traverse((e=>{const n=r.associations.get(e);null!=n&&t.set(e,n)})),t})(i),i}))}_createAnimationTracks(e,t,n,r,i){const o=[],s=e.name?e.name:e.uuid,a=[];let c;switch(et[i.path]===et.weights?e.traverse((function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)})):a.push(s),et[i.path]){case et.weights:c=f.dUE;break;case et.rotation:c=f.iLg;break;case et.position:case et.scale:c=f.yC1;break;default:if(1===n.itemSize)c=f.dUE;else c=f.yC1}const l=void 0!==r.interpolation?tt[r.interpolation]:f.NMF,u=this._getArrayFromAccessor(n);for(let h=0,f=a.length;h<f;h++){const e=new c(a[h]+"."+et[i.path],t.array,u,l);"CUBICSPLINE"===r.interpolation&&this._createCubicSplineTrackInterpolant(e),o.push(e)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=ut(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof f.iLg?Xe:Ve)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function pt(e,t,n){const r=t.attributes,i=[];function o(t,r){return n.getDependency("accessor",t).then((function(t){e.setAttribute(r,t)}))}for(const s in r){const t=$e[s]||s.toLowerCase();t in e.attributes||i.push(o(r[s],t))}if(void 0!==t.indices&&!e.index){const r=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(r)}return f.epp.workingColorSpace!==f.GUF&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${f.epp.workingColorSpace}" not supported.`),st(e,t),function(e,t,n){const r=t.attributes,i=new f.ZzF;if(void 0===r.POSITION)return;{const e=n.json.accessors[r.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(i.set(new f.Pa4(t[0],t[1],t[2]),new f.Pa4(o[0],o[1],o[2])),e.normalized){const t=ut(Ze[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new f.Pa4,t=new f.Pa4;for(let r=0,i=o.length;r<i;r++){const i=o[r];if(void 0!==i.POSITION){const r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){const e=ut(Ze[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(e)}e.boundingBox=i;const s=new f.aLr;i.getCenter(s.center),s.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=s}(e,t,n),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let l=0,u=t.length;l<u;l++){const e=t[l];if(void 0!==e.POSITION&&(r=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);const s=[],a=[],c=[];for(let l=0,u=t.length;l<u;l++){const u=t[l];if(r){const t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){const t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;c.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(c)]).then((function(t){const n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}var dt=console.error;function mt(e){(new S).parse(e,(function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()}),dt)}function yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var bt=.5,gt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),vt(this,"z",-.49),vt(this,"material",new f.nls({color:132,opacity:.3,transparent:!0}))}var t,n,r;return t=e,(n=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13),this.point(0,11.13)],n=(d.H.tableX+1)/4,r=d.H.tableY+bt;[1,2,3,-1,-2,-3].forEach((function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))}));var i=(d.H.tableY+1)/2,o=d.H.tableX+bt;[-1,0,1].forEach((function(n){t.push(e.point(-o,n*i)),t.push(e.point(o,n*i))}));var s=(new f.u9r).setFromPoints(t);return new f.ejS(s,this.material)}},{key:"point",value:function(e,t){return new f.Pa4(e,t,-.485)}}])&&yt(t.prototype,n),r&&yt(t,r),e}();function wt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Tt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var xt=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Tt(this,"scene",new f.xsS),Tt(this,"renderer",void 0),Tt(this,"camera",void 0),Tt(this,"windowWidth",1),Tt(this,"windowHeight",1),Tt(this,"element",void 0),Tt(this,"table",void 0),Tt(this,"geom",{left:0,bottom:0,width:1,height:1}),Tt(this,"ballToCheck",0),this.element=t,t&&this.initialiseScene(t,t.offsetWidth,t.offsetHeight),this.camera=new w(t?t.offsetWidth/t.offsetHeight:1),this.addTable(n)}var t,n,r;return t=e,(n=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null===(e=this.element)||void 0===e?void 0:e.offsetWidth)||this.windowHeight!=(null===(t=this.element)||void 0===t?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t;return!!this.sizeChanged()&&(this.windowWidth=null===(e=this.element)||void 0===e?void 0:e.offsetWidth,this.windowHeight=null===(t=this.element)||void 0===t?void 0:t.offsetHeight,!0)}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera,this.geom)}},{key:"renderCamera",value:function(e,t){var n;if(this.updateSize()){var r,i,o,s,a=Math.floor(this.windowWidth*t.left),c=Math.floor(this.windowHeight*t.bottom),l=Math.floor(this.windowWidth*t.width),u=Math.floor(this.windowHeight*t.height);null===(r=this.renderer)||void 0===r||r.setSize(this.windowWidth,this.windowHeight),null===(i=this.renderer)||void 0===i||i.setViewport(a,c,l,u),null===(o=this.renderer)||void 0===o||o.setScissor(a,c,l,u),null===(s=this.renderer)||void 0===s||s.setScissorTest(!0),e.camera.aspect=l/u}e.camera.updateProjectionMatrix(),null===(n=this.renderer)||void 0===n||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(e,t,n){this.renderer=new f.CP7({antialias:!1}),this.renderer.useLegacyLights=!0,this.renderer.shadowMap.enabled=!1,this.renderer.autoClear=!1,this.renderer.setSize(t,n),this.renderer.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(this.renderer.domElement)}},{key:"addTable",value:function(e){this.scene.add(new f.Mig(3158064,1)),function(e,t,n){(new ge).load(e,(function(e){e.scene.matrixAutoUpdate=!1,t.add(e.scene),null!==n&&n()}),(function(e){return console.log(e.loaded+" bytes loaded")}),dt)}("models/p8.gltf",this.scene,e),this.scene.add((new gt).generateLineSegments())}},{key:"addMesh",value:function(e){this.scene.add(e)}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new f.iWj;return t.setFromProjectionMatrix((new f.yGw).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}])&&wt(t.prototype,n),r&&wt(t,r),e}();function kt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function At(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Rt(e){return Rt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Rt(e)}function Et(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?kt(e):t;var n}function St(e,t){return St=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},St(e,t)}function Mt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Rt(e);if(t){var i=Rt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Et(this,n)}}var Ot=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&St(e,t)}(s,e);var t,n,r,o=Mt(s);function s(e){var t,n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),t=o.call(this),n=kt(t),a=void 0,(r="json")in n?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,t.type=i.t.WATCHAIM,t.json=e,t}return t=s,r=[{key:"fromJson",value:function(e){return new s(e)}}],(n=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}])&&At(t.prototype,n),r&&At(t,r),s}(r.Z);function Pt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _t(e){return _t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_t(e)}function It(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function Ct(e,t){return Ct=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Ct(e,t)}function jt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=_t(e);if(t){var i=_t(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return It(this,n)}}var Lt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ct(e,t)}(s,e);var t,n,r,o=jt(s);function s(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(e=o.call(this)).type=i.t.BEGIN,e}return t=s,(n=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}])&&Pt(t.prototype,n),r&&Pt(t,r),s}(r.Z),Nt=n("./src/events/aimevent.ts");function Ht(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Bt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ft(e){return Ft=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Ft(e)}function Ut(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?Ht(e):t;var n}function Dt(e,t){return Dt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Dt(e,t)}function Gt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ft(e);if(t){var i=Ft(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Ut(this,n)}}var zt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Dt(e,t)}(s,e);var t,n,r,o=Gt(s);function s(e){var t,n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),t=o.call(this),n=Ht(t),a=void 0,(r="tablejson")in n?Object.defineProperty(n,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[r]=a,t.type=i.t.HIT,t.tablejson=e,t}return t=s,r=[{key:"fromJson",value:function(e){return new s(e.tablejson)}}],(n=[{key:"applyToController",value:function(e){return e.handleHit(this)}}])&&Bt(t.prototype,n),r&&Bt(t,r),s}(r.Z);function Kt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Vt(e){return Vt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Vt(e)}function Wt(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function Xt(e,t){return Xt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Xt(e,t)}function Yt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Vt(e);if(t){var i=Vt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Wt(this,n)}}var Zt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xt(e,t)}(s,e);var t,n,r,o=Yt(s);function s(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(e=o.call(this)).type=i.t.ABORT,e}return t=s,(n=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}])&&Kt(t.prototype,n),r&&Kt(t,r),s}(r.Z);function Jt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var qt=function(){function e(t){var n,r,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(r="container")in(n=this)?Object.defineProperty(n,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[r]=i,this.container=t}var t,n,r;return t=e,(n=[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"onFirst",value:function(){}}])&&Jt(t.prototype,n),r&&Jt(t,r),e}();function Qt(e){return Qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Qt(e)}function $t(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function en(e,t){return en=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},en(e,t)}function tn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Qt(e);if(t){var i=Qt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return $t(this,n)}}var nn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&en(e,t)}(n,e);var t=tn(n);function n(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.apply(this,arguments)}return n}(qt);function rn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function on(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function sn(e){return sn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},sn(e)}function an(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?rn(e):t;var n}function cn(e,t){return cn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},cn(e,t)}function ln(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=sn(e);if(t){var i=sn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return an(this,n)}}var un=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&cn(e,t)}(o,e);var t,n,r,i=ln(o);function o(){var e,t,n,r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),e=i.apply(this,arguments),t=rn(e),r=.001,(n="scale")in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,e}return t=o,(n=[{key:"handleAbort",value:function(e){return new nn(this.container)}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue;switch(e.key){case"ArrowLeft":return t.rotateAim(-e.t*this.scale),!0;case"ArrowRight":return t.rotateAim(e.t*this.scale),!0;case"ArrowDown":return t.adjustHeight(-e.t*this.scale),!0;case"ArrowUp":return t.adjustHeight(e.t*this.scale),!0;case"ShiftArrowLeft":return t.adjustSide(e.t*this.scale),!0;case"ShiftArrowRight":return t.adjustSide(-e.t*this.scale),!0;case"KeyPUp":return mt(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(e.t*this.scale*2),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(-e.t*this.scale*10),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(e.t*this.scale*10),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return console.log(this.container.table.serialise()),!0;default:return!1}}}])&&on(t.prototype,n),r&&on(t,r),o}(qt),hn=n("./src/model/outcome.ts");function fn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function pn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function dn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function mn(e){return mn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},mn(e)}function yn(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?fn(e):t;var n}function vn(e,t){return vn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},vn(e,t)}function bn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mn(e);if(t){var i=mn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yn(this,n)}}var gn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&vn(e,t)}(s,e);var t,n,r,o=bn(s);function s(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),dn(fn(n=o.call(this)),"pos",void 0),dn(fn(n),"allTable",void 0),n.pos=e,n.allTable=t,n.type=i.t.PLACEBALL,n}return t=s,r=[{key:"fromJson",value:function(e){return new s((0,p.Bh)(e.pos),e.allTable)}}],(n=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}])&&pn(t.prototype,n),r&&pn(t,r),s}(r.Z);function wn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Tn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function xn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function kn(e){return kn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},kn(e)}function An(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?wn(e):t;var n}function Rn(e,t){return Rn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Rn(e,t)}function En(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=kn(e);if(t){var i=kn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return An(this,n)}}var Sn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Rn(e,t)}(s,e);var t,n,r,o=En(s);function s(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),xn(wn(n=o.call(this)),"init",void 0),xn(wn(n),"shots",void 0),n.init=e,n.shots=t,n.type=i.t.BREAK,n}return t=s,r=[{key:"fromJson",value:function(e){return new s(e.init,e.shots)}}],(n=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}])&&Tn(t.prototype,n),r&&Tn(t,r),s}(r.Z);function Mn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function On(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Pn(e){return Pn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Pn(e)}function _n(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?Mn(e):t;var n}function In(e,t){return In=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},In(e,t)}function Cn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Pn(e);if(t){var i=Pn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _n(this,n)}}var jn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&In(e,t)}(o,e);var t,n,r,i=Cn(o);function o(e){var t,n,r,s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),t=i.call(this,e),n=Mn(t),s=.01,(r="placescale")in n?Object.defineProperty(n,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[r]=s,t.container.table.cue.moveTo(t.container.table.balls[0].pos),t.container.table.cue.aim.power=0,t.container.view.camera.forceMode(t.container.view.camera.aimView),t}return t=o,(n=[{key:"onFirst",value:function(){var e=this.container.table.balls[0];e.pos=new f.Pa4(-11,0,0),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.aimInputs.setButtonText("Place\nBall")}},{key:"handleInput",value:function(e){var t=this.container.table.balls[0].pos;switch(e.key){case"ArrowLeft":t.y=f.M8C.clamp((0,p.NM)(t.y+e.t*this.placescale),-d.H.tableY,d.H.tableY);break;case"ArrowRight":t.y=f.M8C.clamp((0,p.NM)(t.y-e.t*this.placescale),-d.H.tableY,d.H.tableY);break;case"movementXUp":t.y=f.M8C.clamp((0,p.NM)(t.y-e.t*this.placescale*2),-d.H.tableY,d.H.tableY);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"placed",value:function(){return this.container.table.cue.aim.round(),this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sendEvent(new Sn(this.container.table.shortSerialise())),new Yn(this.container)}}])&&On(t.prototype,n),r&&On(t,r),o}(un);function Ln(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Nn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Hn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Bn(e){return Bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Bn(e)}function Fn(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?Ln(e):t;var n}function Un(e,t){return Un=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Un(e,t)}function Dn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Bn(e);if(t){var i=Bn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Fn(this,n)}}var Gn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Un(e,t)}(o,e);var t,n,r,i=Dn(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),Hn(Ln(t=i.call(this,e)),"allStationary",!1),Hn(Ln(t),"pendingState",void 0),t.container.table.outcome=[hn.k.hit(t.container.table.balls[0],t.container.table.cue.aim.power)],t.container.table.hit(),t.container.view.camera.suggestMode(t.container.view.camera.aimView),t.container.table.cue.showHelper(!1),t}return t=o,n=[{key:"handleStationary",value:function(e){this.allStationary=!0;var t=this.container.table;return hn.k.isCueBallPotted(t.balls[0],t.outcome)?(this.container.log("in off"),this.container.isSinglePlayer?new jn(this.container):(this.container.sendEvent(new gn(p.bM,!0)),new sr(this.container))):hn.k.isBallPottedNoFoul(t.balls[0],t.outcome)?(this.container.log("pot"),this.container.sendEvent(new Ot(t.serialise())),new Yn(this.container)):(this.container.log("no pot"),this.container.sendEvent(t.cue.aim),this.container.isSinglePlayer?(this.container.sendEvent(new Ot(t.serialise())),new Yn(this.container)):new sr(this.container))}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],n&&Nn(t.prototype,n),r&&Nn(t,r),o}(un);function zn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Kn(e){return Kn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Kn(e)}function Vn(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function Wn(e,t){return Wn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Wn(e,t)}function Xn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Kn(e);if(t){var i=Kn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Vn(this,n)}}var Yn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Wn(e,t)}(o,e);var t,n,r,i=Xn(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e)).container.table.cue.aimMode(),t.container.table.cue.showHelper(!0),t.container.table.cue.moveTo(t.container.table.balls[0].pos),t.container.table.cue.aim.power=0,t.container.view.camera.suggestMode(t.container.view.camera.aimView),t}return t=o,(n=[{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.hit();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"hit",value:function(){return this.container.table.cue.aim.round(),this.container.sendEvent(new zt(this.container.table.serialise())),new Gn(this.container)}}])&&zn(t.prototype,n),r&&zn(t,r),o}(un);function Zn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Jn(e){return Jn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Jn(e)}function qn(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function Qn(e,t){return Qn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Qn(e,t)}function $n(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Jn(e);if(t){var i=Jn(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return qn(this,n)}}var er=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Qn(e,t)}(o,e);var t,n,r,i=$n(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e)).container.table.outcome=[],t.container.table.hit(),t}return t=o,(n=[{key:"handleAim",value:function(e){return new Yn(this.container)}},{key:"handlePlaceBall",value:function(e){return new jn(this.container)}},{key:"handleWatch",value:function(e){return new sr(this.container)}}])&&Zn(t.prototype,n),r&&Zn(t,r),o}(un);function tr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function nr(e){return nr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},nr(e)}function rr(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function ir(e,t){return ir=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},ir(e,t)}function or(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=nr(e);if(t){var i=nr(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return rr(this,n)}}var sr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ir(e,t)}(o,e);var t,n,r,i=or(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e)).container.table.cue.moveTo(t.container.table.balls[0].pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return t=o,(n=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.balls[0].pos=e.pos,this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new er(this.container)}}])&&tr(t.prototype,n),r&&tr(t,r),o}(un);function ar(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function cr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function lr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ur(e){return ur=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},ur(e)}function hr(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?ar(e):t;var n}function fr(e,t){return fr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},fr(e,t)}function pr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ur(e);if(t){var i=ur(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return hr(this,n)}}var dr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&fr(e,t)}(o,e);var t,n,r,i=pr(o);function o(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1500;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),lr(ar(n=i.call(this,e)),"delay",void 0),lr(ar(n),"shots",void 0),n.shots=t,n.delay=r,n}return t=o,(n=[{key:"onFirst",value:function(){this.playNextShot()}},{key:"playNextShot",value:function(){var e=this,t=this.shots.shift(),n=Nt.f.fromJson(t);this.container.table.cue.aim=n,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.updateAimInput(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),setTimeout((function(){e.container.eventQueue.push(new zt(e.container.table.cue.aim))}),this.delay)}},{key:"handleHit",value:function(e){return this.container.table.outcome=[],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this}},{key:"handleStationary",value:function(e){var t=this;return this.shots.length>0&&setTimeout((function(){t.playNextShot()}),this.delay),this}},{key:"handleInput",value:function(e){return"KeyOUp"==e.key&&this.container.view.camera.toggleMode(),this}}])&&cr(t.prototype,n),r&&cr(t,r),o}(un);function mr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function yr(e){return yr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},yr(e)}function vr(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function br(e,t){return br=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},br(e,t)}function gr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=yr(e);if(t){var i=yr(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return vr(this,n)}}var wr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&br(e,t)}(o,e);var t,n,r,i=gr(o);function o(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),i.apply(this,arguments)}return t=o,(n=[{key:"handleBegin",value:function(e){return this.container.sendEvent(new Ot(this.container.table.serialise())),new jn(this.container)}},{key:"handleWatch",value:function(e){return this.container.table.updateFromSerialised(e.json),new sr(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),new dr(this.container,e.shots)):new jn(this.container)}}])&&mr(t.prototype,n),r&&mr(t,r),o}(un),Tr=n("./src/model/ball.ts");function xr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function kr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ar=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"jitter",value:function(t){return(0,p.wK)(t.clone().add(new f.Pa4(e.noise*(Math.random()-.5),e.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(){return new Tr.e(new f.Pa4(-11,0,0),16444375)}},{key:"diamond",value:function(){var t=new f.Pa4(0,e.gap,0),n=t.clone().applyAxisAngle(e.up,1*Math.PI/3),r=new f.Pa4(d.H.tableX/2,0,0),i=[];return i.push(e.cueBall()),i.push(new Tr.e(e.jitter(r),14736950)),r.add(n),i.push(new Tr.e(e.jitter(r),16751872)),r.sub(t),i.push(new Tr.e(e.jitter(r),5380369)),r.add(n),i.push(new Tr.e(e.jitter(r),5853696)),r.sub(t),i.push(new Tr.e(e.jitter(r),16711680)),r.addScaledVector(t,2),i.push(new Tr.e(e.jitter(r),328965)),r.add(n).sub(t),i.push(new Tr.e(e.jitter(r),685250)),r.sub(t),i.push(new Tr.e(e.jitter(r),553728)),r.add(n),i.push(new Tr.e(e.jitter(r),4063388)),i}}],(n=null)&&xr(t.prototype,n),r&&xr(t,r),e}();function Rr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Er(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Sr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Mr(e){return Mr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Mr(e)}function Or(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?Rr(e):t;var n}function Pr(e,t){return Pr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Pr(e,t)}function _r(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Mr(e);if(t){var i=Mr(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Or(this,n)}}kr(Ar,"noise",.05),kr(Ar,"gap",1+2*Ar.noise),kr(Ar,"up",new f.Pa4(0,0,-1));var Ir=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Pr(e,t)}(s,e);var t,n,r,o=_r(s);function s(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),Sr(Rr(n=o.call(this)),"sender",void 0),Sr(Rr(n),"message",void 0),n.sender=e,n.message=t,n.type=i.t.CHAT,n}return t=s,r=[{key:"fromJson",value:function(e){return new s(e.sender,e.message)}}],(n=[{key:"applyToController",value:function(e){return e.handleChat(this)}}])&&Er(t.prototype,n),r&&Er(t,r),s}(r.Z);function Cr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var jr=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromSerialised",value:function(e){var t=JSON.parse(e);switch(t.type){case i.t.BEGIN:return new Lt;case i.t.AIM:return Nt.f.fromJson(t);case i.t.BREAK:return Sn.fromJson(t);case i.t.WATCHAIM:return Ot.fromJson(t.json);case i.t.HIT:return zt.fromJson(t);case i.t.CHAT:return Ir.fromJson(t);case i.t.ABORT:return new Zt;case i.t.PLACEBALL:return gn.fromJson(t);default:throw Error("Unknown GameEvent :"+e)}}}],(n=null)&&Cr(t.prototype,n),r&&Cr(t,r),e}();function Lr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Nr=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Lr(this,"t",void 0),Lr(this,"key",void 0),this.t=t,this.key=n};function Hr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Br(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Fr=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Br(this,"cueBallElement",void 0),Br(this,"cueTipElement",void 0),Br(this,"cuePowerElement",void 0),Br(this,"cueHitElement",void 0),Br(this,"container",void 0),Br(this,"ballWidth",void 0),Br(this,"ballHeight",void 0),Br(this,"tipRadius",void 0),Br(this,"mousemove",(function(e){1===e.buttons&&n.adjustSpin(e)})),Br(this,"hit",(function(e){n.container.table.cue.setPower(n.cuePowerElement.value),n.container.inputQueue.push(new Nr(0,"SpaceUp"))})),Br(this,"mousewheel",(function(e){n.cuePowerElement.value-=Math.sign(e.deltaY)/10,n.container.table.cue.setPower(n.cuePowerElement.value),n.container.lastEventTime=performance.now()})),this.container=t,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.addListeners()}var t,n,r;return t=e,(n=[{key:"addListeners",value:function(){var e,t,n,r=this;null===(e=this.cueBallElement)||void 0===e||e.addEventListener("pointermove",this.mousemove),null===(t=this.cueBallElement)||void 0===t||t.addEventListener("click",(function(e){r.adjustSpin(e)})),null===(n=this.cueHitElement)||void 0===n||n.addEventListener("click",this.hit),document.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null===(e=this.cueBallElement)||void 0===e?void 0:e.offsetWidth,this.ballHeight=null===(t=this.cueBallElement)||void 0===t?void 0:t.offsetHeight,this.tipRadius=(null===(n=this.cueTipElement)||void 0===n?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){var n;this.readDimensions();var r=null===(n=this.cueTipElement)||void 0===n?void 0:n.style;r&&(r.left=(.5-e)*this.ballWidth-this.tipRadius+"px",r.top=(.5-t)*this.ballHeight-this.tipRadius+"px")}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null===(t=this.cuePowerElement)||void 0===t?void 0:t.value)&&(this.cuePowerElement.value=e)}}])&&Hr(t.prototype,n),r&&Hr(t,r),e}();function Ur(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Gr=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Dr(this,"listener",new f.SJI),Dr(this,"audioLoader",new f.mTL),Dr(this,"ballcollision",void 0),Dr(this,"cue",void 0),Dr(this,"cushion",void 0),Dr(this,"pot",void 0),t.add(this.listener),this.ballcollision=new f.BbS(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new f.BbS(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new f.BbS(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new f.BbS(this.listener),this.load("sounds/pot.ogg",this.pot)}var t,n,r;return t=e,n=[{key:"load",value:function(e,t){this.audioLoader.load(e,(function(e){t.setBuffer(e),t.setLoop(!1)}))}},{key:"play",value:function(e,t){e.setVolume(t),e.isPlaying&&e.stop(),e.play(f.M8C.randFloat(0,.01))}},{key:"eventToSounds",value:function(e){"collision"===e.type&&(this.play(this.ballcollision,e.incidentSpeed/60),this.ballcollision.setDetune(10*e.incidentSpeed)),"pot"===e.type&&(this.play(this.pot,e.incidentSpeed/60),this.pot.setDetune(10*e.incidentSpeed-1e3)),"cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/120),"hit"===e.type&&this.play(this.cue,e.incidentSpeed/60)}}],n&&Ur(t.prototype,n),r&&Ur(t,r),e}();function zr(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function Kr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Vr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Wr=function(){function e(t){var n,r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Vr(this,"chatoutput",void 0),Vr(this,"chatInput",void 0),Vr(this,"chatSend",void 0),Vr(this,"chatInputText",void 0),Vr(this,"send",void 0),Vr(this,"sendClicked",(function(e){var t,n;r.send(null===(t=r.chatInputText)||void 0===t?void 0:t.value),r.showMessage(null===(n=r.chatInputText)||void 0===n?void 0:n.value)})),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null===(n=this.chatSend)||void 0===n||n.addEventListener("click",this.sendClicked),this.send=t}var t,n,r;return t=e,(n=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e+"<br>"),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}])&&Kr(t.prototype,n),r&&Kr(t,r),e}();function Xr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Yr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Zr=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Yr(this,"period",void 0),Yr(this,"pending",null),Yr(this,"sentTime",0),Yr(this,"apply",(function(e){})),this.period=t,this.apply=n}var t,n,r;return t=e,(n=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==i.t.AIM)return this.flush(),this.apply(e),void(this.sentTime=performance.now());this.pending=e}}])&&Xr(t.prototype,n),r&&Xr(t,r),e}();function Jr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function qr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Qr=function(){function e(t,n,r,i,o){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),qr(this,"table",void 0),qr(this,"view",void 0),qr(this,"controller",void 0),qr(this,"inputQueue",[]),qr(this,"eventQueue",[]),qr(this,"keyboard",void 0),qr(this,"sound",void 0),qr(this,"chat",void 0),qr(this,"id",""),qr(this,"isSinglePlayer",!0),qr(this,"last",performance.now()),qr(this,"step",.001953125),qr(this,"broadcast",void 0),qr(this,"log",void 0),qr(this,"sendChat",(function(e){s.sendEvent(new Ir(s.id,e))})),qr(this,"throttle",new Zr(250,(function(e){s.broadcast(jr.serialise(e))}))),qr(this,"lastEventTime",performance.now()),this.log=n,this.table=new h.i(Ar.diamond()),this.view=new xt(t,i),this.table.cue.aimInputs=new Fr(this),this.keyboard=r,this.sound=new Gr(this.view.camera.camera),this.chat=new Wr(this.sendChat),this.id=o,this.table.balls.forEach((function(e){s.view.addMesh(e.ballmesh.mesh),s.view.addMesh(e.ballmesh.shadow),s.view.addMesh(e.ballmesh.spinAxisArrow)})),this.view.addMesh(this.table.cue.mesh),this.view.addMesh(this.table.cue.helperMesh),this.view.addMesh(this.table.cue.placerMesh),this.view.table=this.table,this.updateController(new wr(this))}var t,n,r;return t=e,(n=[{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){for(var t=Math.floor(e/this.step),n=t*this.step,r=this.table.allStationary(),i=0;i<t;i++)this.table.advance(this.step);this.table.updateBallMesh(n),this.view.update(n,this.table.cue.aim),this.table.cue.update(n),!r&&this.table.allStationary()?this.eventQueue.push(new u):this.table.outcome.length}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach((function(t){return e.inputQueue.push(t)}));this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+1e4||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame((function(e){t.animate(e)}))}},{key:"updateController",value:function(e){var t;e!==this.controller&&(this.log("Transition to "+(zr(t=e,wr)?"Init":zr(t,jn)?"PlaceBall":zr(t,Yn)?"Aim":zr(t,sr)?"WatchAim":zr(t,Gn)?"PlayShot":zr(t,er)?"WatchShot":zr(t,dr)?"Replay":zr(t,nn)?"End":"UNKNOWN")),this.controller=e,this.controller.onFirst())}}])&&Jr(t.prototype,n),r&&Jr(t,r),e}(),$r=n("./node_modules/interactjs/dist/interact.min.js"),ei=n.n($r);function ti(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ni(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ri=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ni(this,"pressed",{}),ni(this,"released",{}),ni(this,"keydown",(function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),ni(this,"keyup",(function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),ni(this,"mousetouch",(function(e){var t=e.dx;n.released.movementX?n.released.movementX+=t:n.released.movementX=t})),this.addHandlers(t),/Android|iPhone/i.test(navigator.userAgent)||(t.contentEditable="true")}var t,n,r;return t=e,(n=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter((function(e){return!/Shift/.test(e)})).filter((function(e){return!/Control/.test(e)})),n=Object.keys(this.pressed).some((function(e){return/Shift/.test(e)})),r=Object.keys(this.pressed).some((function(e){return/Control/.test(e)})),i=[];return t.forEach((function(t){var o=performance.now()-e.pressed[t];i.push(new Nr(r?o/3:o,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())})),Object.keys(this.released).forEach((function(t){return i.push(new Nr(e.released[t],t+"Up"))})),this.released={},i}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),ei()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}})}}])&&ti(t.prototype,n),r&&ti(t,r),e}();function ii(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var si,ai,ci,li=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),oi(this,"ws",void 0),oi(this,"eventHandler",void 0),console.log("connecting to "+t),this.ws=new WebSocket(t),this.ws.onopen=this.log,this.ws.onclose=this.log,this.ws.onerror=function(e){console.log(e)},this.ws.onmessage=function(e){if(r=e.data,null!=(i=ArrayBuffer)&&"undefined"!=typeof Symbol&&i[Symbol.hasInstance]?i[Symbol.hasInstance](r):r instanceof i){var t=String.fromCharCode.apply(null,Array.from(new Uint16Array(e.data)));console.log(t)}else n.eventHandler(e.data);var r,i}}var t,n,r;return t=e,(n=[{key:"send",value:function(e){this.ws.send(e)}},{key:"log",value:function(e){console.log("socket:",e.type),e.data&&e.data.text().then((function(e){return console.log(e)}))}}])&&ii(t.prototype,n),r&&ii(t,r),e}(),ui=null,hi={init:null,shots:Array()};function fi(){console.log("".concat(si," ready")),ai&&(hi=JSON.parse(decodeURI(ai)),ci.eventQueue.push(new Sn(hi.init,hi.shots))),ui||ci.eventQueue.push(new Sn),ci.animate(performance.now())}function pi(e){var t=jr.fromSerialised(e);console.log("".concat(si," received ").concat(t.type)),ci.eventQueue.push(t)}function di(e){var t,n=jr.fromSerialised(e);n.type===i.t.BREAK&&(hi.init=n.init),n.type===i.t.HIT&&function(e){hi.shots.push(e);var t=JSON.stringify(hi),n=encodeURI("".concat(window.location,"?state=").concat(t)),r='<a class="pill" target="_blank" href="'.concat(n,'">break of ').concat(hi.shots.length,"</a>");ci.eventQueue.push(new Ir(si,r))}(n.tablejson.aim),null===(t=ui)||void 0===t||t.send(e)}!function(){var e,t,n=new URLSearchParams(location.search),r=n.get("websocketserver"),i=null!==(e=n.get("table"))&&void 0!==e?e:"default";si=null!==(t=n.get("name"))&&void 0!==t?t:"",ai=n.get("state");var o=document.getElementById("viewP1"),s=new ri(o);(ci=new Qr(o,console.log,s,fi,si)).broadcast=di,r&&((ui=new li("".concat(r,"?name=").concat(si,"&table=").concat(i))).eventHandler=pi,ci.isSinglePlayer=!1)}()},"./src/model/ball.ts":(e,t,n)=>{n.d(t,{e:()=>p,Z:()=>c});var r=n("./node_modules/three/build/three.module.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/physics.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c,l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"mesh",void 0),a(this,"shadow",void 0),a(this,"spinAxisArrow",void 0),a(this,"m",new r.yGw),this.initialiseMesh(t)}var t,n,o;return t=e,(n=[{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t,r=this.m.identity().makeRotationAxis((0,i.KO)(e),n);this.mesh.geometry.applyMatrix4(r)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(.4+t.length()/2,.1,.1),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,i.KO)(t)),n==c.Rolling?this.spinAxisArrow.setColor(16711680):this.spinAxisArrow.setColor(65280)}},{key:"initialiseMesh",value:function(e){var t=new r.cJO(.5,1),n=new r.xoR({emissive:0,flatShading:!0,vertexColors:!0});this.addDots(t,e),this.mesh=new r.Kj0(t,n),this.mesh.name="ball",this.updateRotation((new r.Pa4).random(),1);var o=new r.zf8(.45,9);o.applyMatrix4((new r.yGw).identity().makeTranslation(0,0,-.49));var s=new r.vBJ({color:1118498});this.shadow=new r.Kj0(o,s),this.spinAxisArrow=new r.tGC(i.up,i.bM,2,0),this.spinAxisArrow.visible=!1}},{key:"addDots",value:function(e,t){var n=this,i=e.attributes.position.count,o=new r.Ilk(t),s=new r.Ilk(11149858);e.setAttribute("color",new r.TlE(new Float32Array(3*i),3));for(var a=e.attributes.color,c=0;c<i/3;c++)this.colorVerticesForFace(c,a,o.r,o.g,o.b);[0,96,111,156,186,195].forEach((function(e){n.colorVerticesForFace(e/3,a,s.r,s.g,s.b)}))}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}}])&&s(t.prototype,n),o&&s(t,o),e}(),u=n("./src/model/physics/constants.ts");function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket"}(c||(c={}));var p=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f(this,"pos",void 0),f(this,"vel",i.bM.clone()),f(this,"rvel",i.bM.clone()),f(this,"state",c.Stationary),f(this,"pocket",void 0),f(this,"futurePos",i.bM.clone()),f(this,"ballmesh",void 0),f(this,"transition",.05),f(this,"dv",new r.Pa4),f(this,"dw",new r.Pa4),this.pos=t.clone(),this.ballmesh=new l(n||5592405*Math.random())}var t,n,s;return t=e,s=[{key:"fromSerialised",value:function(t){return e.updateFromSerialised(new e((0,i.Bh)(t.pos)),t)}},{key:"updateFromSerialised",value:function(e,t){return e.pos.copy(t.pos),e.vel.copy((0,i.Bh)(t.vel)),e.rvel.copy((0,i.Bh)(t.rvel)),e.state=t.state,e}}],(n=[{key:"update",value:function(e){this.updatePosition(e),this.updateVelocity(e),this.state==c.Falling&&this.updateFalling(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updatePosition(this.pos),this.ballmesh.updateArrows(this.pos,this.rvel,this.state),0!==this.rvel.lengthSq()&&this.ballmesh.updateRotation(this.rvel,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateFalling",value:function(e){if(this.vel.addScaledVector(i.up,-10*e*u.g),this.pos.z<-2&&(this.pos.z+=r.M8C.randFloat(-.5,.25),this.setStationary(),this.state=c.InPocket),this.pos.distanceTo(this.pocket.pos)>this.pocket.radius-.5){var t=this.pocket.pos.clone().sub(this.pos).normalize().multiplyScalar(.5*this.vel.length());this.vel.dot(t)<0&&(this.vel.x=t.x,this.vel.y=t.y)}}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?this.updateVelocityRolling(e):this.updateVelocitySliding(e))}},{key:"updateVelocityRolling",value:function(e){(0,o.QC)(this.rvel,this.dv,this.dw),this.dv.multiplyScalar(e),this.dw.multiplyScalar(e),(0,i.Ls)(this.rvel,this.dw)||(0,i.Ls)(this.vel,this.dv)?this.setStationary():(this.vel.add(this.dv),this.rvel.add(this.dw),this.state=c.Rolling)}},{key:"updateVelocitySliding",value:function(e){(0,o.Vp)(this.vel,this.rvel,this.dv,this.dw),this.dv.multiplyScalar(e),this.dw.multiplyScalar(e),(0,i.Ls)(this.rvel,this.dw)&&(0,i.Ls)(this.vel,this.dv)?this.setStationary():(this.vel.add(this.dv),this.rvel.add(this.dw),this.state=c.Sliding)}},{key:"setStationary",value:function(){this.vel.copy(i.bM),this.rvel.copy(i.bM),this.state=c.Stationary}},{key:"isRolling",value:function(){return 0!=this.vel.lengthSq()&&0!=this.rvel.lengthSq()&&(0,o.E9)(this.vel,this.rvel).length()<this.transition}},{key:"onTable",value:function(){return this.state!==c.Falling&&this.state!==c.InPocket}},{key:"inMotion",value:function(){return this.state==c.Rolling||this.state==c.Sliding}},{key:"isFalling",value:function(){return this.state==c.Falling}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"serialise",value:function(){return{pos:this.pos,vel:this.vel,rvel:this.rvel,state:this.state}}}])&&h(t.prototype,n),s&&h(t,s),e}()},"./src/model/outcome.ts":(e,t,n)=>{function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o;n.d(t,{k:()=>s}),function(e){e.Pot="Pot",e.Cushion="Cushion",e.Collision="Collision",e.Hit="Hit"}(o||(o={}));var s=function(){function e(t,n,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"type",void 0),i(this,"timestamp",void 0),i(this,"ballA",null),i(this,"ballB",null),i(this,"incidentSpeed",void 0),this.type=t,this.ballA=n,this.ballB=r,this.incidentSpeed=o,this.timestamp=Date.now()}var t,n,s;return t=e,s=[{key:"pot",value:function(t,n){return new e(o.Pot,t,t,n)}},{key:"cushion",value:function(t,n){return new e(o.Cushion,t,t,n)}},{key:"collision",value:function(t,n,r){return new e(o.Collision,t,n,r)}},{key:"hit",value:function(t,n){return new e(o.Hit,t,t,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some((function(t){return t.type==o.Pot&&t.ballA===e}))}},{key:"isBallPottedNoFoul",value:function(t,n){return n.some((function(e){return e.type==o.Pot&&null!==e.ballA}))&&!e.isCueBallPotted(t,n)}}],(n=null)&&r(t.prototype,n),s&&r(t,s),e}()},"./src/model/physics/constants.ts":(e,t,n)=>{n.d(t,{Dt:()=>l,Ew:()=>m,G3:()=>w,Hz:()=>i,I:()=>o,Mz:()=>r,R:()=>f,Xm:()=>T,dE:()=>v,e:()=>p,f7:()=>g,fN:()=>y,g:()=>s,m:()=>h,zq:()=>b,zv:()=>c});var r,i,o,s=9.8,a=.29,c=.89,l=.4,u=.4,h=.2,f=.5,p=.85;function d(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function m(e){f=e,d()}function y(e){h=e,d()}function v(e){a=e,d()}function b(e){u=e,d()}function g(e){c=e}function w(e){p=e}function T(e){l=e}d()},"./src/model/physics/knuckle.ts":(e,t,n)=>{n.d(t,{T:()=>a});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/constants.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"pos",void 0),s(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,a;return t=e,a=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<.5+e.radius}},{key:"findBouncing",value:function(t,n){var i=t.futurePosition(n);return r.H.knuckles.find((function(t){return e.willBounce(t,i)}))}}],(n=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*i.e*n),Math.abs(n)}}])&&o(t.prototype,n),a&&o(t,a),e}()},"./src/model/physics/physics.ts":(e,t,n)=>{n.d(t,{E9:()=>a,GK:()=>w,NP:()=>b,QC:()=>l,Vp:()=>c,WL:()=>T,ZI:()=>u,al:()=>v,c0:()=>y,s0:()=>m,vZ:()=>g});var r=n("./node_modules/three/build/three.module.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts");function s(e,t){return a(e,t).setZ(0)}function a(e,t){return e.clone().addScaledVector((0,i.a1)(t),o.R)}function c(e,t,n,r){var a=s(e,t);n.copy((0,i.KO)(a).multiplyScalar(-o.zv*o.g)),r.copy((0,i.KO)((0,i.a1)(a)).multiplyScalar(2.5*o.zv*o.g/o.R)),r.setZ(o.Mz/(o.R*o.R)*-2.5*Math.sign(t.z))}function l(e,t,n){var i=new r.Pa4(e.x,e.y,0).length(),s=5/7*o.Hz/(o.m*o.R)/i,a=5/7*o.Hz/(o.m*o.R*o.R)/i;t.set(-s*e.y,s*e.x,0),n.set(-a*e.x,-a*e.y,o.Mz/(o.m*o.R*o.R)*-2.5*Math.sign(e.z))}function u(e,t,n,r,s){!function(e,t,n,r){var i,s,a=y(e),c=m(e,t),l=b(a),u=v(c),h=3.5/o.m,f=1/o.m,g=(1+o.e)*(a/f),T=0;if(u<l)i=-c.x/h*p-g*d,s=c.y/h,T=c.x/h*d-g*p;else{var x=w(e),k=Math.abs(Math.atan2(e.y,e.x)),A=Math.cos(k),R=Math.sin(k);i=-x*g*A*d-g*d,s=x*g*R,T=x*g*A*d-g*p}n.x=i/o.m,n.y=s/o.m,r.x=-o.R/o.I*s*p,r.y=o.R/o.I*(i*p-T*d),r.z=o.R/o.I*s*d}(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e),r,s),r.applyAxisAngle(i.up,-e),s.applyAxisAngle(i.up,-e)}var h=.2*o.R,f=Math.asin(h/o.R),p=Math.sin(f),d=Math.cos(f);function m(e,t){return new r.Pa4(e.x*p-e.z*d+o.R*t.y,-e.y-o.R*t.z*d+o.R*t.x*p)}function y(e){return e.x*d}function v(e){var t=3.5/o.m;return e.length()/t}function b(e){var t=1/o.m;return o.Dt*((1+o.e)*e)/t}function g(e,t){var n=b(y(e));return v(m(e,t))<=n}function w(e){return.2-.1*Math.atan2(Math.abs(e.y),e.x)}function T(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.a1)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts":(e,t,n)=>{n.d(t,{f:()=>c});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"pos",void 0),a(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,c;return t=e,c=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(t,n){var r=t.futurePosition(n);return i.H.pocketCenters.find((function(t){return e.willFall(t,r)}))}}],(n=[{key:"fall",value:function(e,t){return e.vel.z=-o.g*t,e.state=r.Z.Falling,e.pocket=this,e.vel.length()}}])&&s(t.prototype,n),c&&s(t,c),e}()},"./src/model/table.ts":(e,t,n)=>{n.d(t,{i:()=>A});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./node_modules/three/build/three.module.js");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,a;return t=e,a=[{key:"bounceAny",value:function(t,n){var i=t.futurePosition(n);if(e.willBounceLongSegment(r.H.pockets.pocketNW.knuckleNE.pos.x,r.H.pockets.pocketN.knuckleNW.pos.x,i)||e.willBounceLongSegment(r.H.pockets.pocketN.knuckleNE.pos.x,r.H.pockets.pocketNE.knuckleNW.pos.x,i)){var o=i.y>r.H.tableY?-Math.PI/2:Math.PI/2;return e.bounceIn(o,t)}if(e.willBounceShortSegment(r.H.pockets.pocketNW.knuckleSW.pos.y,r.H.pockets.pocketSW.knuckleNW.pos.y,i)){var s=i.x>r.H.tableX?0:Math.PI;return e.bounceIn(s,t)}}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.H.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.H.tableX}},{key:"bounceIn",value:function(e,t){var n=new o.Pa4,r=new o.Pa4;return(0,i.ZI)(e,t.vel,t.rvel,n,r),t.vel.add(n),t.rvel.add(r),n.length()}}],(n=null)&&s(t.prototype,n),a&&s(t,a),e}(),c=n("./src/model/ball.ts");function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<1}},{key:"collide",value:function(t,n){return e.updateVelocities(t,n)}},{key:"updateVelocities",value:function(e,t){var n=t.pos.clone().sub(e.pos).normalize(),r=n.dot(e.vel),i=n.dot(t.vel);return e.vel.addScaledVector(n,i).addScaledVector(n,-r),t.vel.addScaledVector(n,r).addScaledVector(n,-i),e.state=c.Z.Sliding,t.state=c.Z.Sliding,Math.abs(r)+Math.abs(i)}}],(n=null)&&l(t.prototype,n),r&&l(t,r),e}(),h=n("./src/model/physics/knuckle.ts"),f=n("./src/model/physics/pocket.ts"),p=n("./src/utils/utils.ts"),d=n("./src/events/aimevent.ts");function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"createHelper",value:function(){var e=new o.fHI(.5,.5,30,12,1,!0),t=new o.Kj0(e,this.helpermaterial);return t.geometry.applyMatrix4((new o.yGw).identity().makeRotationAxis(p.up,-Math.PI/2)).applyMatrix4((new o.yGw).identity().makeTranslation(15,0,-.01)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var t=new o.fHI(.01,.5,.5,4),n=new o.Kj0(t,e.helpermaterial);return n.geometry.applyMatrix4((new o.yGw).identity().makeRotationAxis(new o.Pa4(1,0,0),-Math.PI/2)).applyMatrix4((new o.yGw).identity().makeTranslation(0,0,.7)),n.visible=!1,n}},{key:"createCue",value:function(t,n,r){var i=new o.fHI(t,n,r,11),s=new o.Kj0(i,e.material);return s.castShadow=!1,s.geometry.applyMatrix4((new o.yGw).identity().makeRotationAxis(new o.Pa4(1,0,0),-.1)).applyMatrix4((new o.yGw).identity().makeRotationAxis(p.up,-Math.PI/2)).applyMatrix4((new o.yGw).identity().makeTranslation(-r/2-.5,0,1)),s}}],(n=null)&&m(t.prototype,n),r&&m(t,r),e}();function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}y(v,"material",new o.xoR({color:8934775,wireframe:!1,flatShading:!1})),y(v,"helpermaterial",new o.jyz({uniforms:{lightDirection:{value:new o.Pa4(0,0,1)}},vertexShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;  \n      void main() {\n        vNormal = normal;\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n      }\n    ",fragmentShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;\n      uniform vec3 lightDirection;\n      void main() {\n        float intensity = dot(vNormal, lightDirection);\n        vec3 color = vec3(1.0, 1.0, 1.0);\n        vec3 finalColor = color * intensity;\n        gl_FragColor = vec4(finalColor, 0.05 * (1.0-vUv.y));\n      }\n    ",wireframe:!1,transparent:!0}));var w=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),g(this,"mesh",void 0),g(this,"helperMesh",void 0),g(this,"placerMesh",void 0),g(this,"limit",.5),g(this,"maxPower",60),g(this,"t",0),g(this,"aimInputs",void 0),g(this,"aim",new d.f),g(this,"length",1*r.H.tableX),this.mesh=v.createCue(.05,.15,this.length),this.helperMesh=v.createHelper(),this.placerMesh=v.createPlacer()}var t,n,s;return t=e,(n=[{key:"rotateAim",value:function(e){this.aim.angle+=e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle}},{key:"adjustHeight",value:function(e){this.aim.verticalOffset=o.M8C.clamp(this.aim.verticalOffset+e,-this.limit,this.limit),this.mesh.position.z=this.aim.verticalOffset,this.updateAimInput()}},{key:"adjustSide",value:function(e){this.aim.sideOffset=o.M8C.clamp(this.aim.sideOffset+e,-this.limit,this.limit),this.updateAimInput()}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;e.state=c.Z.Sliding,e.vel.copy((0,p.AA)(t.angle).multiplyScalar(t.power));var n=new o.Pa4(t.sideOffset,t.verticalOffset,0);e.rvel.copy((0,i.WL)(n,e.vel))}},{key:"setSpin",value:function(e,t){var n=new o.Pa4(e,t);n.length()>.26&&n.normalize().multiplyScalar(.25),this.aim.verticalOffset=n.y,this.aim.sideOffset=n.x,this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t;null===(e=this.aimInputs)||void 0===e||e.updateVisualState(this.aim.sideOffset,this.aim.verticalOffset),null===(t=this.aimInputs)||void 0===t||t.updatePowerSlider(this.aim.power/this.maxPower)}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=(0,p.a1)((0,p.AA)(this.aim.angle)).multiplyScalar(this.aim.sideOffset).setZ(this.aim.verticalOffset),n=.25*(Math.sin(this.t/3)-1),r=(0,p.AA)(this.aim.angle).clone().multiplyScalar(n-this.aim.power/this.maxPower*3);this.mesh.position.copy(e.clone().add(t).add(r)),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"intersectsAnything",value:function(e){var t=e.balls[0].pos.clone().addScaledVector((0,p.AA)(this.aim.angle),-this.length/2);t.z=this.aim.verticalOffset;var n=(0,p.AA)(this.aim.angle);return new o.iMs(t,n,0,this.length/2-.6).intersectObjects(e.balls.map((function(e){return e.ballmesh.mesh}))).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}])&&b(t.prototype,n),s&&b(t,s),e}(),T=n("./src/model/outcome.ts");function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),k(this,"balls",void 0),k(this,"cue",new w),k(this,"pairs",void 0),k(this,"outcome",[]),this.initialiseBalls(t)}var t,n,i;return t=e,i=[{key:"fromSerialised",value:function(t){var n=new e(t.balls.map((function(e){return c.e.fromSerialised(e)})));return n.updateFromSerialised(t),n}}],(n=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach((function(t){t.updateMesh(e)}))}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw new Error("Depth exceeded resolving collisions");this.balls.forEach((function(t){t.update(e)}))}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every((function(n){return t.prepareAdvancePair(n.a,n.b,e)}))&&this.balls.every((function(n){return t.prepareAdvanceToCushions(n,e)}))}},{key:"prepareAdvancePair",value:function(e,t,n){if(u.willCollide(e,t,n)){var r=u.collide(e,t);return this.outcome.push(T.k.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.H.tableY&&Math.abs(n.x)<r.H.tableX)return!0;var i=a.bounceAny(e,t);if(i)return this.outcome.push(T.k.cushion(e,i)),!1;var o=h.T.findBouncing(e,t);if(o){var s=o.bounce(e);return this.outcome.push(T.k.cushion(e,s)),!1}var c=f.f.findPocket(e,t);if(c){var l=c.fall(e,t);return this.outcome.push(T.k.pot(e,l)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every((function(e){return!e.inMotion()||!e.onTable()}))}},{key:"hit",value:function(){this.cue.hit(this.balls[0])}},{key:"serialise",value:function(){return{balls:this.balls.map((function(e){return e.serialise()})),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){e.balls&&this.balls.forEach((function(t,n){return c.e.updateFromSerialised(t,e.balls[n])})),e.aim&&(this.cue.aim=d.f.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map((function(e){return[e.pos.x,e.pos.y]})).reduce((function(e,t){return e.concat(t)}),[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach((function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1]}))}}])&&x(t.prototype,n),i&&x(t,i),e}()},"./src/utils/utils.ts":(e,t,n)=>{n.d(t,{AA:()=>u,Bh:()=>s,KO:()=>c,Ls:()=>l,NM:()=>h,a1:()=>a,bM:()=>i,up:()=>o,wK:()=>f});var r=n("./node_modules/three/build/three.module.js"),i=new r.Pa4(0,0,0),o=new r.Pa4(0,0,1);function s(e){return new r.Pa4(e.x,e.y,e.z)}function a(e){return o.clone().cross(e)}function c(e){return e.clone().normalize()}function l(e,t){return e.clone().add(t).dot(e)<=0}function u(e){return new r.Pa4(1,0,0).applyAxisAngle(o,e)}function h(e){return Math.round(1e3*(e+Number.EPSILON))/1e3}function f(e){return e.x=h(e.x),e.y=h(e.y),e.z=h(e.z),e}},"./src/view/tablegeometry.ts":(e,t,n)=>{n.d(t,{H:()=>c});var r=n("./node_modules/three/build/three.module.js"),i=n("./src/model/physics/knuckle.ts"),o=n("./src/model/physics/pocket.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,i=[{key:"addToScene",value:function(t){e.knuckles.forEach((function(n){return e.knuckleCylinder(n,t)})),e.pocketCenters.forEach((function(n){return e.knuckleCylinder(n,t)}))}},{key:"knuckleCylinder",value:function(t,n){e.cylinder(t.pos,t.radius,.75,n).position.setZ(-.125)}},{key:"cylinder",value:function(t,n,i,o){var s=new r.fHI(n,n,i,16),a=new r.Kj0(s,e.material);return a.position.copy(t),a.geometry.applyMatrix4((new r.yGw).identity().makeRotationAxis(new r.Pa4(1,0,0),Math.PI/2)),o.add(a),a}},{key:"addCushions",value:function(t){e.plane(new r.Pa4(0,0,-5.5),2*e.X,2*e.Y,10,t);var n=.75,i=-.125,o=Math.abs(e.pockets.pocketNW.knuckleNE.pos.x-e.pockets.pocketN.knuckleNW.pos.x),s=Math.abs(e.pockets.pocketNW.knuckleSW.pos.y-e.pockets.pocketSW.knuckleNW.pos.y);e.plane(new r.Pa4(e.X+.5,0,i),1,s,n,t),e.plane(new r.Pa4(-e.X-.5,0,i),1,s,n,t),e.plane(new r.Pa4(-e.X/2,e.Y+.5,i),o,1,n,t),e.plane(new r.Pa4(-e.X/2,-e.Y-.5,i),o,1,n,t),e.plane(new r.Pa4(e.X/2,e.Y+.5,i),o,1,n,t),e.plane(new r.Pa4(e.X/2,-e.Y-.5,i),o,1,n,t)}},{key:"plane",value:function(t,n,i,o,s){var a=new r.DvJ(n,i,o),c=new r.Kj0(a,e.material);c.receiveShadow=!0,c.position.copy(t),s.add(c)}}],(n=null)&&s(t.prototype,n),i&&s(t,i),e}();a(c,"tableX",21.5),a(c,"tableY",10.5),a(c,"X",c.tableX+.5),a(c,"Y",c.tableY+.5),a(c,"PX",c.tableX+.8),a(c,"PY",c.tableY+.8),a(c,"knuckleInset",1.6),a(c,"knuckleRadius",.31),a(c,"middleKnuckleInset",1.385),a(c,"middleKnuckleRadius",.2),a(c,"cornerRadius",1.1),a(c,"middleRadius",.9),a(c,"pockets",{pocketNW:{pocket:new o.f(new r.Pa4(-c.PX,c.PY,0),c.cornerRadius),knuckleNE:new i.T(new r.Pa4(-c.X+c.knuckleInset,c.Y+c.knuckleRadius,0),c.knuckleRadius),knuckleSW:new i.T(new r.Pa4(-c.X-c.knuckleRadius,c.Y-c.knuckleInset,0),c.knuckleRadius)},pocketN:{pocket:new o.f(new r.Pa4(0,c.PY+.7,0),c.middleRadius),knuckleNE:new i.T(new r.Pa4(c.middleKnuckleInset,c.Y+c.middleKnuckleRadius,0),c.middleKnuckleRadius),knuckleNW:new i.T(new r.Pa4(-c.middleKnuckleInset,c.Y+c.middleKnuckleRadius,0),c.middleKnuckleRadius)},pocketS:{pocket:new o.f(new r.Pa4(0,-c.PY-.7,0),c.middleRadius),knuckleSE:new i.T(new r.Pa4(c.middleKnuckleInset,-c.Y-c.middleKnuckleRadius,0),c.middleKnuckleRadius),knuckleSW:new i.T(new r.Pa4(-c.middleKnuckleInset,-c.Y-c.middleKnuckleRadius,0),c.middleKnuckleRadius)},pocketNE:{pocket:new o.f(new r.Pa4(c.PX,c.PY,0),c.cornerRadius),knuckleNW:new i.T(new r.Pa4(c.X-c.knuckleInset,c.Y+c.knuckleRadius,0),c.knuckleRadius),knuckleSE:new i.T(new r.Pa4(c.X+c.knuckleRadius,c.Y-c.knuckleInset,0),c.knuckleRadius)},pocketSE:{pocket:new o.f(new r.Pa4(c.PX,-c.PY,0),c.cornerRadius),knuckleNE:new i.T(new r.Pa4(c.X+c.knuckleRadius,-c.Y+c.knuckleInset,0),c.knuckleRadius),knuckleSW:new i.T(new r.Pa4(c.X-c.knuckleInset,-c.Y-c.knuckleRadius,0),c.knuckleRadius)},pocketSW:{pocket:new o.f(new r.Pa4(-c.PX,-c.PY,0),c.cornerRadius),knuckleSE:new i.T(new r.Pa4(-c.X+c.knuckleInset,-c.Y-c.knuckleRadius,0),c.knuckleRadius),knuckleNW:new i.T(new r.Pa4(-c.X-c.knuckleRadius,-c.Y+c.knuckleInset,0),c.knuckleRadius)}}),a(c,"knuckles",[c.pockets.pocketNW.knuckleNE,c.pockets.pocketNW.knuckleSW,c.pockets.pocketN.knuckleNW,c.pockets.pocketN.knuckleNE,c.pockets.pocketS.knuckleSW,c.pockets.pocketS.knuckleSE,c.pockets.pocketNE.knuckleNW,c.pockets.pocketNE.knuckleSE,c.pockets.pocketSE.knuckleNE,c.pockets.pocketSE.knuckleSW,c.pockets.pocketSW.knuckleSE,c.pockets.pocketSW.knuckleNW]),a(c,"pocketCenters",[c.pockets.pocketNW.pocket,c.pockets.pocketSW.pocket,c.pockets.pocketN.pocket,c.pockets.pocketS.pocket,c.pockets.pocketNE.pocket,c.pockets.pocketSE.pocket]),a(c,"material",new r.xoR({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.4}))}},e=>{var t;t="./src/index.ts",e(e.s=t)}]);